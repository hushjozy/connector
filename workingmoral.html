
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>

    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://github.com/WalletConnect/walletconnect-monorepo/releases/download/1.7.1/web3-provider.min.js"></script>
    <script src="https://unpkg.com/moralis/dist/moralis.js"></script>
<link rel="stylesheet" href="/dappstyle.css">
    <title></title>
  </head>
  <body>
    <div class="">
      <button class="button_wc" id="btn-login" onclick="authenticate()">Connect Wallet</button>
      <button class="button_logout" id="btn-logout">Logout</button>
      <button id="btn-get-stats">Refresh Stats</button>
    <ul id="gas-stats"></ul>
    </div>


<script type="text/javascript">
  Moralis.initialize("qzmwR7GsUDMGwahH6Z13MXUCZvi0D0Dw9lrvJG2h");
Moralis.serverURL = ("https://fjhqwoplnapa.usemoralis.com:2053/server");

var user;
var web3 = window.web3;
var ethAvail = window.ethereum;
//let web3;
let result = '';
var walletAddress;
// let provider;
const provider = 'walletconnect';

function getTokens() {
  // walletAddress = user.get('ethAddress');
  console.log(user.get('ethAddress'));
  // resultBox.innerText = user.get('ethAddress');

  $.ajax({
    url:"/das/wallet/",
    headers: { "X-CSRFToken":  getCookiesCSRF("csrftoken")},
    type: "POST",
    dataType: "json",
    data:{
        walletAddress: user.get('ethAddress')
    },
    success: function(result) {
      console.log("SUCCESS");
      console.log(result["sbsc_balance"]);
      sbscAmount.innerHTML = `SBSC: ${result["sbsc_balance"]}<br>(${result["dollar_sbsc"]}\$)`;
      //sbscAmountDollar.innerHTML = `(${result["dollar_sbsc"]}\$)`;
      console.log(result["satoshi_URLs"]);
      var URLs = result["satoshi_URLs"];
      console.log(URLs);
      // nftViewer.style.display = "inline";
      // nftViewer.style.justifyContent = "center";
      // nftViewer.style.textAlign = "center";


      // nftViewer.style.width = "5%";

      // nftCaption.style.justifyContent = "center";
      // nftCaption.style.textAlign = "center";
      // nftCaption.style.display = "inline";

      if (URLs.length > 0) {
        //  block of code to be executed if the condition is true

        var imgs = URLs.map(function(URL) {
          var img = new Image();
          console.log(URL[0]);
          img.src = URL[0];
          img.style.width = "100%";
          img.style.padding = "1%";
        img.style.height = "auto";

        var inner_div = document.createElement('div');
        inner_div.style.verticalAlign = "top";
        inner_div.style.display = "inline-block";
        inner_div.style.textAlign = "center";
        inner_div.style.width = "30%";
        inner_div.style.height = "auto";
        inner_div.style.padding = "1%";
        inner_div.style.whiteSpace = "normal";

        //img.style.display = "inline-block";

          // document.body.appendChild(img);
            //var theDiv = document.getElementById("nft_viewer");
            // var content = document.createTextNode("Image");
            // theDiv.appendChild(content);
            inner_div.appendChild(img);

          var z = document.createElement('span'); // is a node
          z.innerHTML = `Series: ${URL[4]}<br>ID: ${URL[3]} <br> Rarity Points: ${URL[1]} <br> Rank: ${URL[2]}`;
          //z.style.textAlign = "center";
          z.style.display = "block";
          z.style.color = "white";
          z.style.fontSize = "0.8em";
          z.style.fontWeight = "500";
          //z.style.verticalAlign = "bottom";
          //var content = document.createTextNode("<YOUR_CONTENT>");
          inner_div.appendChild(z);

          nftViewer.appendChild(inner_div);

          return img;
        });
      } else {
        nftHeader.innerHTML = '';
      }



      // resultBox.innerText = result["sbsc_balance"];
    },
    fail: function(result){
      console.log("Some error");
    }
});

}
function getNFTs() {
  // walletAddress = user.get('ethAddress');
  console.log(user.get('ethAddress'));
  // resultBox.innerText = user.get('ethAddress');

//   $.ajax({
//     url:"/dapps/nfts/",
//     headers: { "X-CSRFToken":  getCookiesCSRF("csrftoken")},
//     type: "POST",
//     dataType: "json",
//     data:{
//         walletAddress: user.get('ethAddress')
//     },
//     success: function(result) {
//       console.log("SUCCESS");
//       console.log(result["sbsc_balance"]);
//       // resultBox.innerText = result["sbsc_balance"];
//     },
//     fail: function(result){
//       console.log("Some error");
//     }
// });

}


function renderApp() {
  user = Moralis.User.current();

  if (user) {
    // authButton.style.display = 'block';
    // logoutButton.style.display = 'inline-block';
    // nftMain.style.display = 'block';
    // nftHeader.style.display = 'block';
console.log(user)
    // subheader.innerText = `Welcome ${user.get('ethAddress')}`;

    if (web3) {
      // callButton.style.display = 'inline-block';
      // enableButton.style.display = 'none';
    } else {
      // callButton.style.display = 'none';
      // enableButton.style.display = 'inline-block';
    }
  } else {
    // authButton.style.display = 'inline-block';
     // callButton.style.display = 'none';
    // logoutButton.style.display = 'none';
    // nftMain.style.display = 'none';
    // nftHeader.style.display = 'none';
    // subheader.innerText = '';
    // enableButton.style.display = 'none';
  }
  getTokens();
  // enableWeb3();

  // resultBox.innerText = result;
}

async function authenticate() {
  try {
  //   user = await Moralis.Web3.authenticate({
  //     provider: "walletconnect"} );
  //   web3 = await Moralis.Web3.enable({
  //     provider: "walletconnect",

  //     // mobileLinks: [
  //     //   "rainbow",
  //     //   "metamask",
  //     //   "argent",
  //     //   "trust",
  //     //   "imtoken",
  //     //   "pillar",
  //     // ]
  // });
  // console.log(typeof web3);
if (typeof web3 !== 'undefined') {
  const user = await Moralis.authenticate();
  web3 = await Moralis.enable();

} else if (window.ethereum) {
const user = await Moralis.authenticate();
web3 = await Moralis.enable();

}
else {
const user = await Moralis.authenticate({  provider: "walletconnect"});
web3 = await Moralis.enable({  provider: "walletconnect" });
}
  walletAddress = user.get('ethAddress');
  // console.log(user.get('ethAddress'));
} catch (error) {
  console.log('authenticate failed', error);
  // await Moralis.User.logOut();
}
renderApp();
}

// window.addEventListener('load', function() {

//   // Check if Web3 has been injected by the browser (Mist/MetaMask).
//   if (typeof web3 !== 'undefined') {
//     // Use Mist/MetaMask's provider.
//     web3js = new Web3(web3.currentProvider);
//   } else {
//     // Handle the case where the user doesn't have web3. Probably
//     // show them a message telling them to install Metamask in
//     // order to use the app.
//   }

// });

async function enableWeb3() {
  try {
    web3 = await Moralis.Web3.enable({ provider });
    console.log('Successfully enabled web3');
  } catch (error) {
    console.log('testCall failed', error);
  }
}
 async function logOut() {
   await Moralis.User.logOut();
   console.log("logged out");
 }
 document.getElementById("btn-login").onclick = authenticate;
 document.getElementById("btn-logout").onclick = logOut;
 document.getElementById("btn-get-stats").onclick = getStats;

 // refresh stats
 function getStats() {
   const user = Moralis.User.current();
   if (user) {
     getUserTransactions(user);
   }
   getAverageGasPrices();
 }

 // HISTORICAL TRANSACTIONS
 async function getUserTransactions(user) {
   // create query
   const query = new Moralis.Query("EthTransactions");
   query.equalTo("from_address", user.get("ethAddress"));

   // subscribe to query updates
   const subscription = await query.subscribe();
   handleNewTransaction(subscription);

   // run query
   const results = await query.find();
   console.log("user transactions:", results);
 }

 // REAL-TIME TRANSACTIONS
 async function handleNewTransaction(subscription) {
   // log each new transaction
   subscription.on("create", function (data) {
     console.log("new transaction: ", data);
   });
 }

 // CLOUD FUNCTION
 async function getAverageGasPrices() {
   const results = await Moralis.Cloud.run("getAvgGas");
   console.log("average user gas prices:", results);
   renderGasStats(results);
 }

 function renderGasStats(data) {
   const container = document.getElementById("gas-stats");
   container.innerHTML = data
     .map(function (row, rank) {
       return `<li>#${rank + 1}: ${Math.round(row.avgGas)} gwei</li>`;
     })
     .join("");
 }
console.log(typeof web3);
 //get stats on page load
 getStats();
 renderApp();
</script>

    </body>
</html>
