<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://unpkg.com/moralis/dist/moralis.js"></script>
  <link rel="stylesheet" href="/dappstyle.css">
  </head>
  <body>
    <div class="entry">
          </div>
      <h1>Gas Stats With Moralis</h1>

          <button class="button_wc" id="btn-login">Moralis Login</button>
          <button class="button_logout" id="btn-logout">Logout</button>
          <button id="btn-get-stats">Refresh Stats</button>

          <ul id="gas-stats"></ul>
          <script>
            // connect to Moralis server

            const serverUrl = "https://fjhqwoplnapa.usemoralis.com:2053/server";
            const appId = "qzmwR7GsUDMGwahH6Z13MXUCZvi0D0Dw9lrvJG2h";
            Moralis.start({ serverUrl, appId });
            // add from here down
            // LOG IN WITH METAMASK
            /* Authentication code */
       async function login() {
         let web3;
if (provider == 'walletconnect') {
          const user = await Moralis.authenticate({ provider: provider});
          web3 = await Moralis.enable({ provider });
} else {
          const user = await Moralis.authenticate();
          web3 = await Moralis.enable();
}
         // if (!user) {
         //   user = await Moralis.authenticate({
         //     signingMessage: "Log in using Moralis",
         //   })
         //     .then(function (user) {
         //       console.log("logged in user:", user);
         //       console.log(user.get("ethAddress"));
         //     })
         //     .catch(function (error) {
         //       console.log(error);
         //     });
         // }
       }

       async function logOut() {
         await Moralis.User.logOut();
         console.log("logged out");
       }

     // bind button click handlers
     document.getElementById("btn-login").onclick = login;
     document.getElementById("btn-logout").onclick = logOut;
     document.getElementById("btn-get-stats").onclick = getStats;

     // refresh stats
     function getStats() {
       const user = Moralis.User.current();
       if (user) {
         getUserTransactions(user);
       }
       getAverageGasPrices();
     }

     // HISTORICAL TRANSACTIONS
     async function getUserTransactions(user) {
       // create query
       const query = new Moralis.Query("EthTransactions");
       query.equalTo("from_address", user.get("ethAddress"));

       // subscribe to query updates
       const subscription = await query.subscribe();
       handleNewTransaction(subscription);

       // run query
       const results = await query.find();
       console.log("user transactions:", results);
     }

     // REAL-TIME TRANSACTIONS
     async function handleNewTransaction(subscription) {
       // log each new transaction
       subscription.on("create", function (data) {
         console.log("new transaction: ", data);
       });
     }

     // CLOUD FUNCTION
     async function getAverageGasPrices() {
       const results = await Moralis.Cloud.run("getAvgGas");
       console.log("average user gas prices:", results);
       renderGasStats(results);
     }

     function renderGasStats(data) {
       const container = document.getElementById("gas-stats");
       container.innerHTML = data
         .map(function (row, rank) {
           return `<li>#${rank + 1}: ${Math.round(row.avgGas)} gwei</li>`;
         })
         .join("");
     }

     //get stats on page load
     getStats();
          </script>

  </body>
</html>
